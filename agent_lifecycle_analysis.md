# Agent Lifecycle Analysis

This document outlines the lifecycle of an Eliza Agent, focusing on its initialization, configuration, and the recurring operations managed by the `TasksService` (`src/cron/tasks.service.ts`).

## Agent Lifecycle Overview

The agent lifecycle can be broadly divided into two phases:

### Phase 1: Agent Setup & Configuration (Assumed Prerequisites)

These actions are foundational for an agent to become operational and interact with the system. They are largely external to `tasks.service.ts` but are implied by its interactions.

*   **Agent Initialization**: An agent is created, configured, and started, reaching a `RUNNING` status. (Likely managed by services like `start-container.steps.ts`).
*   **Portfolio Definition**: The agent's initial trading portfolio is established.
*   **Cryptocurrency Assignment**: Specific cryptocurrencies for trading are assigned to the agent. (User mentioned "crypto_selection" files).
*   **Strategy Definition**:
    *   **Target Allocation Strategy**: The agent defines its target asset allocation percentages (accessible by the agent via a function like `get_target_allocation`).
    *   **Entry/Exit Strategy**: The agent defines its specific conditions and rules for entering and exiting trades (accessible by the agent via a function like `get_strategy_text`).

### Phase 2: Recurring Operations (Managed by `TasksService`)

Once an agent is `RUNNING` and configured, `TasksService` orchestrates several recurring tasks:

## Detailed Table of Actions

| Phase/Category        | Action/Event                                                                | Trigger/Frequency (Cron Expression)  | Managing Function(s) in `tasks.service.ts`                                  | Key Prompt/Instruction (to Agent)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | File(s) in `tasks.service.ts` Related | Notes                                                                                                                                                                                            |
| :-------------------- | :-------------------------------------------------------------------------- | :----------------------------------- | :-------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------ | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Agent Setup**       | Initial Agent Creation & Start                                              | On-demand / External                 | N/A (External to `tasks.service.ts`)                                        | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | External                              | Agent must be `RUNNING` with `runtimeAgentId` and `port`.                                                                                                                                        |
|                       | Portfolio Setup                                                             | On-demand / External                 | N/A (External to `tasks.service.ts`)                                        | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | External                              | Agent manages its own portfolio.                                                                                                                                                                 |
|                       | Crypto List Assignment                                                      | On-demand / External                 | N/A (External to `tasks.service.ts`)                                        | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | External                              | Agents are instructed to focus on *their* assigned cryptos.                                                                                                                                      |
|                       | Define Target Allocation Strategy                                           | On-demand / External                 | N/A (External to `tasks.service.ts`)                                        | Agent makes this accessible via `get_target_allocation`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | External                              | Strategy is defined by/for the agent.                                                                                                                                                            |
|                       | Define Entry/Exit Strategy                                                  | On-demand / External                 | N/A (External to `tasks.service.ts`)                                        | Agent makes this accessible via `get_strategy_text`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | External                              | Strategy is defined by/for the agent.                                                                                                                                                            |
| **Agent Interaction** | Instruct Agent for Trade Simulation (Agent internally performs: <br>1. Retrieve Strategies (`get_target_allocation`, `get_strategy_text`) <br>2. Focus on Assigned Crypto <br>3. Assess Paradex Market <br>4. Decide: Simulate Trade or Wait <br>5. Generate Justification) | `'0 */4 * * *'` (Every 4 hours)      | `TasksService.sendTradeSimulation`, `MessageService.sendMessageToAgent`     | `Before making any trading decision, FIRST retrieve your target allocation strategy (with get_target_allocation) and your entry/exit strategy (with get_strategy_text) that you previously defined. ONLY focus on the cryptocurrencies that were specifically assigned to you and mentioned in your strategy text. After reviewing these strategies, assess current market conditions on Paradex. If you see a compelling opportunity that aligns with your predefined entry conditions AND target allocation percentages, simulate a spot trade. If current conditions don't match your personal criteria defined in your strategy text, it's perfectly acceptable to wait. Your decision MUST be consistent with your previously defined strategies and should only involve the cryptocurrencies specifically assigned to you. Explain your reasoning in your own voice, focusing on how this decision aligns with your predefined strategy.` | `src/cron/tasks.service.ts`           | Agent is expected to call its internal `get_target_allocation` and `get_strategy_text` functions. The "simulate trade" action and subsequent portfolio balance update are distinct steps from the hourly balance update request. |
|                       | Request Portfolio Balance Update                                            | `'04 * * * *'` (Hourly, at minute 4) | `TasksService.sendPortfolioBalanceUpdate`, `MessageService.sendMessageToAgent` | `"execute send_portfolio_balance"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `src/cron/tasks.service.ts`           | Agent sends its current portfolio balance to the backend. This is a separate, more frequent update than any balance reporting post-trade-simulation.                                                                                                                                        |
| **Backend Support**   | Generate Paradex Asset Analysis                                             | `CronExpression.EVERY_HOUR`          | `TasksService.generateParadexAnalysis` -> `processCryptoAnalysisInBatches`  | N/A (Backend to backend API call to `/analysis/generate`)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `src/cron/tasks.service.ts`           | Provides market analysis data. Uses `config/crypto/tradable_crypto.json`.                                                                                                                        |
|                       | Synchronize Token Prices                                                    | `'55 * * * *'` (Hourly, at minute 55) | `TasksService.syncTokenPrices` -> `TokenPriceSyncService.syncPrices`        | N/A (Service call)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `src/cron/tasks.service.ts`           | Ensures up-to-date token prices for the system. Relies on `TokenPriceSyncService`.                                                                                                               |
|                       | Update Agent Performance Snapshots                                          | `'0 * * * *'` (Hourly, at minute 0)  | `TasksService.updateAgentPerformanceSnapshots` -> `PerformanceSnapshotService.createAgentPerformanceSnapshot` | N/A (Service call)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `src/cron/tasks.service.ts`           | Captures historical PnL and other metrics for running agents. Relies on `PerformanceSnapshotService`.                                                                                            |
|                       | Update Creator Leaderboard                                                  | `'*/5 * * * *'` (Every 5 minutes)    | `TasksService.updateCreatorLeaderboard` -> `CreatorsService.calculateAndStoreLeaderboard` | N/A (Service call)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `src/cron/tasks.service.ts`           | Calculates and stores leaderboard data for creators. Relies on `CreatorsService`.                                                                                                                |
|                       | Cleanup Performance Data (Data Retention)                                   | `'0 0 * * *'` (Daily at midnight)    | `TasksService.cleanupPerformanceData` -> `PerformanceSnapshotService.applyDataRetentionPolicy` | N/A (Service call)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `src/cron/tasks.service.ts`           | Applies data retention policy for performance snapshots. Relies on `PerformanceSnapshotService`.                                                                                                 |

## Commented-Out / Potentially Deprecated Functionality in `tasks.service.ts`

The following cron jobs are currently commented out in `src/cron/tasks.service.ts` and may indicate past or future functionality:

| Function Name               | Original Cron Expression        | Brief Description                                                                                                                                 |
| :-------------------------- | :------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------ |
| `handleCron`                | `CronExpression.EVERY_HOUR`     | Was intended to send Starknet messages to running agents.                                                                                         |
| `sendActOnParadexMessage`   | `CronExpression.EVERY_HOUR`     | Was intended to send a direct "EXECUTE ACT_ON_PARADEX" command to agents with a detailed prompt for market analysis and trading.                     |
| `generateAvnuAnalysis`      | `'10 */4 * * *'`                | Was intended to generate asset analysis for AVNU platform for a specific list of tickers (`BROTHER`, `STRK`, `LORDS`, `USDC`, `ETH`, `UNI`).       |

## Key Files Referenced (from `tasks.service.ts` context)

*   `src/cron/tasks.service.ts`: Main file containing the cron job definitions and logic discussed.
*   `src/message/message.service.ts`: Used by `TasksService` to send messages (prompts) to agents.
*   `src/shared/prisma/prisma.service.ts`: Used for database interactions (e.g., finding running agents).
*   `src/domains/kpi/services/performance-snapshot.service.ts`: Used for managing agent performance data.
*   `src/domains/creators/interfaces/creators-service.interface.ts` & its implementation: Used for creator leaderboard updates.
*   `src/domains/token-price-sync/token-price-sync.service.ts`: Used for synchronizing token prices.
*   `config/crypto/tradable_crypto.json`: Configuration file listing tradable cryptocurrencies, loaded by `getTradableCryptos()` for market analysis generation.

This document should provide a clear overview for job passing and understanding the agent's operational cycle based on the provided code. 